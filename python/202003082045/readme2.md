## 传输层篇
> 网络层只是提供了一个虚拟的互联网络，可是浏览器和网站后台是怎么通信呢？
其实这个可以看做是进程与进程之间的通信，前面学的是本地进程之间的通信，现在我们要学的是网络之间通信方式。

- 使用端口(Port)来标记不同的网络进程;
- 端口(Port)使用16比特位表示(0~65535);
|FTP|SSH|HTTP|HTTPS|DNS|TELNET|
|:--:|:--:|:--:|:--:|:--:|:--:|
|21|22|80|443|53|23|

***
### 一、UDP协议详解
#### (1)、UDP(User Datagram Protocol:用户数据报协议)
- 数据报(datagram)
 - 不合并，不拆分
- UDP的位置:

<table style="text-align:center">
<tr><td>--</td><td>--</td><td colspan="2">UDP数据报的数据<b>(应用层数据)</b></td><td>--</td></tr>
<tr><td>--</td><td>IP首部</td><td colspan="2">IP数据报的数据</td><td>--</td></tr>
<tr><td>--</td><td colspan="3">IP数据报</td><td>--</td></tr>
<tr><td>帧首部</td><td colspan="3">帧的数据</td><td>帧尾部</td></tr>
</table>

- UDP的结构:

<table style="text-align:center">
	<tr><td>16位源端口</td><td>16位目的端口号</td></tr>
	<tr><td>16位UDP长度</td><td>16位UDP校验和</td></tr>
	<tr><td colspan="2">UDP数据</td></tr>
</table>          

#### (2)、UDP是一个简单的协议
- 特点：
 - UDP是无连接的协议;
 - UDP不能保证可靠地交付数据;
 - UDP是面向报文传输的;
 - UDP没有拥塞机制;
 - UDP首部开销很小;
***
### 二、TCP协议详解
#### (1)、TCP(Transmisstion Control Protocol:传输控制协议)
- TCP的位置:

<table style="text-align:center">
<tr><td>--</td><td>--</td><td>TCP首部</td><td>TCP数据报的数据</td><td>--</td></tr>
<tr><td>--</td><td>IP首部</td><td colspan="2">IP数据报的数据</td><td>--</td></tr>
<tr><td>--</td><td colspan="3">IP数据报</td><td>--</td></tr>
<tr><td>帧首部</td><td colspan="3">帧的数据</td><td>帧尾部</td></tr>
</table>

- TCP的结构

<table style="text-align:center">
	<tr><td colspan="16">16位源端口</td><td colspan="16">16位目标端口</td></tr>
	<tr><td colspan="32">序号</td></tr>
	<tr><td colspan="32">确认号</td></tr>
	<tr><td colspan="4">数据偏移</td><td colspan="6">保留字段</td><td colspan="6">TCP标记</td><td colspan="16">窗口</td></tr>
	<tr><td colspan="16">校验和</td><td colspan="16">紧急指针</td></tr>
	<tr><td colspan="32">TCP选项填充(可选)</td></tr>
</table>

> 前五行固定20字节
**序号**:范围0-2^32-1，一个字节一个符号，32字节。数据首字节序号。
**确认号**:范围0-2^32-1，一个字节一个符号，32字节。期待收到数据的首字节序号。(类似offset)
- 确认号为N:则表示N-1序号的数据都已经收到
**数据偏移**:占4位，0~15，单位为:32位字。数据偏移首部的距离
**TCP标记**：占6位，每位都有不同含义;

|标记|含义|
|--|--|
|URG|Uragent:紧急位，URG=1,表示紧急数据|
|ACK|Acknowledgement:确认位,ACK=1,确认号才生效|
|PSH|Push推送位,Push=1,尽快把数据交付给应用层|
|RST|Reset:重置位，RST=1,重新建立连接|
|SYN|Synchronization:同步位,SYN=1表示连接请求报文|
|FIN|Finish:终止位，FIN=1表示释放连接|

> **窗口**：占16位,0~2^16-1。窗口指明允许对方发送的数据量。(类型limit)
**紧急指针**：当URG=1时，指定紧急数据位于报文的位置。
**TCP选项(可选)**：最多40字节，支持未来的扩展;

#### (2)、TCP协议是计算机网络中非常复杂的一个协议
- 特点:
 - TCP是一个面向连接的协议;
 - TCP的一个连接有两个端(点对点通信);
 - TCP提供可靠的传输服务;
 - TCP是一个全双工的通信;
 - TCP是面向字节流的协议;
### 三、可靠传输的基本原理
#### (1)、停止等待协议
- 发送方和接收方都有停止和等待的过程，当链路出现差错的时候或者确认的消息很久才收到，会触发超时重传机制，保证可靠传输。
- 超时定时器
 - 没发送一条消息，都需要设置一个定时器
- 停止等待协议是简单的可靠传输协议
- 停止等待协议对信道的利用率不高
#### (2)、连续ARQ协议
- ARQ(Automatic Repeat reQuest:自动重传请求)
 - 滑动窗口
 - 累计确认
***
### 四、TCP协议的可靠传输
#### (1)、TCP的可靠传输基于连续AEQ协议
> 如果确认号延时收到或者无法收到，那么就需要重新重该确认号开始依次重传，所以说TCP效率并不高

#### (2)、选择重传
- i.TCP的滑动窗口以字节为单位
 - 选择重传需要指定需要重传的字节
 - 每一个字节都有唯一的32位序号，存储在TCP选项(可选)区域，最多40字节
 - TCP的序号最多可以有10个序号
- TCP首部20~60字节
- ii.TCP协议的选择重传
 - 现阶段的TCP是指定一个边界，如1000~2000,执行其中字节流的重传
***
### 五、TCP协议的流量控制
> 流量控制是指让发送方发送速率不要太快
#### (1)、流量控制是使用滑动串口来实现的
#### (2)、坚持定时器(为了解决窗口死锁而产生)
 - 当接收到窗口为0的消息，则启动坚持定时器;
 - 坚持定时器每隔一段时间发送一个窗口探测报文;
***
### 六、TCP协议的拥塞控制
- 原因:
 - 一条数据链路经过非常多的设备
 - 数据链路中各个部分都有可能成为网络传输的瓶颈
- 流量控制考虑点对点的通信量的控制
- 拥塞控制考虑整个网络，是全局性的考虑
 - 报文超时则认为是拥塞
#### (1)、慢启动算法
- 由小到大逐渐增加发送数据量
- 每收到一个报文确认，就加一
> 1-->2-->4-->8-->16->..
呈指数增长，但有慢启动阈值(ssthresh)
#### (2)、拥塞避免算法
- 维护一个拥塞窗口的变量
- 只要不发生拥塞，就试探着拥塞窗口跳大
> 1-->2-->4-->8-->16(ssthresh阈值)
启动sshresh算法，将窗口+1，即，17，18，19这样的执行重传，直到发生拥塞

***
### 七、TCP协议连接
#### (1)、三次握手的过程

图1

**seq(sequence number)**
#### (2)、为什么发送方要发出第三个确认报文呢？
- 已经失效的连接请求报文传送到对方，引起错误;

图2

*** 
### 八、TCP协议释放
#### (1)、四次挥手的过程

图3

#### (2)、等待计时器(TIME-WAIT)
- 2MSL(Max Segment Lifetime):最长报文段寿命
- MSL通常设置为2分钟，2MSL就是2*2=4分钟
- 为什么需要2MSL?
 - 最后一个报文没有确认
 - 确保发送方的ACK可以到达接收方
 - 2MSL时间内没有收到，则接收方会重发
 - 确保当前连接的所有报文都已经过期
***
### 九、套接字与域套接字编程
- 使用端口(Port)可以标识不同的网络进程;
- 端口(Port)使用16比特位表示(0~65535);
**IP:Port**
- 套接字(Socket)是抽象概念，表示TCP连接的一端
- 通过套接字可以进行数据发送或接受
**TCP连接由两个套接字组成**

#### (1)、套接字的流程
##### i.服务端
创建套接字-->绑定(Bind)套接字-->监听(listen)套接字-->接受&处理信息
##### ii.客户端
创建套接字-->连接(Connect)套接字-->发送信息
##### iii.socket-python代码案例
- server.py


- client.py


#### (2)、网络套接字和域套接字的区别:
 - 网络套接字需要经过计算机的应用层、传输层、网络层和网络接口层的多个协议栈,传输效率慢;
 - 域套接字经过域套接字文件(s类型)传输，在单机情况下传输效率更快;
***